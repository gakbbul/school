<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시간표 급식표 조회</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Noto Sans KR) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Noto Sans KR 폰트 적용 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-white transition-colors duration-300">

    <!-- 메인 화면 -->
    <div id="main-view">
        <!-- 이 부분은 JavaScript를 통해 동적으로 채워집니다. -->
    </div>

    <!-- 설정 화면 -->
    <div id="settings-view" class="hidden">
        <!-- 이 부분은 JavaScript를 통해 동적으로 채워집니다. -->
    </div>

    <script>
        // 전역 상태 변수
        let schoolInfo = {
            name: '',
            code: '',
            regionCode: '',
            regionName: '',
            grade: '',
            class: '',
        };
        let view = 'main'; // 'main' 또는 'settings'
        let customTimetable = {};
        let date = new Date();
        let weather = null;
        let meal = null;
        let timetable = null;
        let isLoading = false;
        let searchQuery = '';
        let searchResults = [];

        // API 키 및 URL
        const NEIS_API_KEY = "2ab5d56a9a7a4baeba5b12519dd6369b";
        const NEIS_API_URL = "https://open.neis.go.kr/hub/";
        const WEATHER_API_URL_FORECAST = "https://api.open-meteo.com/v1/forecast";
        
        // DOM 요소
        const mainViewContainer = document.getElementById('main-view');
        const settingsViewContainer = document.getElementById('settings-view');

        // WMO 날씨 코드를 한글로 변환
        const getWeatherDescription = (code) => {
            switch (code) {
                case 0: return '맑음';
                case 1: return '주로 맑음';
                case 2: return '부분적으로 흐림';
                case 3: return '흐림';
                case 45: case 48: return '안개';
                case 51: case 53: case 55: return '이슬비';
                case 56: case 57: return '어는 이슬비';
                case 61: case 63: case 65: return '비';
                case 66: case 67: return '어는 비';
                case 71: case 73: case 75: return '눈';
                case 77: return '눈송이';
                case 80: case 81: case 82: return '소나기';
                case 85: case 86: return '눈 소나기';
                case 95: return '천둥 번개';
                case 96: case 99: return '우박을 동반한 천둥 번개';
                default: return '정보 없음';
            }
        };
        
        // 주요 음력 공휴일 및 대체 공휴일 (양력 기준)
        const getLunarHolidaysForYear = (year) => {
            const lunarHolidaysMap = {
                2024: [
                    { month: 2, day: 9, name: "설날 연휴" }, { month: 2, day: 10, name: "설날" }, { month: 2, day: 11, name: "설날 연휴" },
                    { month: 5, day: 15, name: "부처님 오신 날" },
                    { month: 9, day: 16, name: "추석 연휴" }, { month: 9, day: 17, name: "추석" }, { month: 9, day: 18, name: "추석 연휴" },
                ],
                2025: [
                    { month: 1, day: 28, name: "설날 연휴" }, { month: 1, day: 29, name: "설날" }, { month: 1, day: 30, name: "설날 연휴" },
                    { month: 6, day: 1, name: "부처님 오신 날" }, { month: 6, day: 2, name: "대체 공휴일 (부처님 오신 날)" },
                    { month: 10, day: 5, name: "추석 연휴" }, { month: 10, day: 6, name: "추석" }, { month: 10, day: 7, name: "추석 연휴" }, { month: 10, day: 8, name: "대체 공휴일 (추석)" },
                ],
                2026: [
                    { month: 2, day: 16, name: "설날 연휴" }, { month: 2, day: 17, name: "설날" }, { month: 2, day: 18, name: "설날 연휴" },
                    { month: 5, day: 25, name: "부처님 오신 날" },
                    { month: 9, day: 25, name: "추석 연휴" }, { month: 9, day: 26, name: "추석" }, { month: 9, day: 27, name: "추석 연휴" }, { month: 9, day: 28, name: "대체 공휴일 (추석)" },
                ],
                2027: [
                    { month: 2, day: 8, name: "설날 연휴" }, { month: 2, day: 9, name: "설날" }, { month: 2, day: 10, name: "설날 연휴" },
                    { month: 5, day: 15, name: "부처님 오신 날" }, { month: 5, day: 17, name: "대체 공휴일 (부처님 오신 날)" },
                    { month: 9, day: 15, name: "추석 연휴" }, { month: 9, day: 16, name: "추석" }, { month: 9, day: 17, name: "추석 연휴" },
                ],
                2028: [
                    { month: 1, day: 25, name: "설날 연휴" }, { month: 1, day: 26, name: "설날" }, { month: 1, day: 27, name: "설날 연휴" },
                    { month: 5, day: 12, name: "부처님 오신 날" },
                    { month: 10, day: 2, name: "추석 연휴" }, { month: 10, day: 3, name: "추석 (개천절 중복)" }, { month: 10, day: 4, name: "추석 연휴" }, { month: 10, day: 5, name: "대체 공휴일 (추석)" },
                ]
            };
            return lunarHolidaysMap[year] || [];
        };

        // 법정 공휴일 확인
        const isPublicHoliday = (d) => {
            const year = d.getFullYear();
            const month = d.getMonth() + 1;
            const day = d.getDate();
            const fixedHolidays = [
                { month: 1, day: 1, name: "신정" }, { month: 3, day: 1, name: "삼일절" },
                { month: 5, day: 5, name: "어린이날" }, { month: 5, day: 6, name: "대체 공휴일 (어린이날)" }, // 2024년 기준
                { month: 6, day: 6, name: "현충일" }, { month: 8, day: 15, name: "광복절" },
                { month: 10, day: 3, name: "개천절" }, { month: 10, day: 9, name: "한글날" },
                { month: 12, day: 25, name: "성탄절" },
            ];
            let holiday = fixedHolidays.find(h => h.month === month && h.day === day);
            if (holiday) return holiday.name;
            const lunarHolidays = getLunarHolidaysForYear(year);
            holiday = lunarHolidays.find(h => h.month === month && h.day === day);
            if (holiday) return holiday.name;
            return false;
        };

        // API 데이터 가져오기
        const fetchData = async () => {
            isLoading = true;
            render(); 

            if (isPublicHoliday(date) || isWeekend(date)) {
                weather = null;
                meal = null;
                timetable = null;
            }
            
            try {
                // 날씨 데이터 (Open-Meteo)
                 let forecastForSelectedDay = null;
                 const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${schoolInfo.regionName}&count=1&language=ko&format=json`);
                 const geoData = await geoResponse.json();
                 if (geoData.results && geoData.results.length > 0) {
                     const { latitude, longitude } = geoData.results[0];
                     const weatherResponse = await fetch(`${WEATHER_API_URL_FORECAST}?latitude=${latitude}&longitude=${longitude}&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max&timezone=auto&forecast_days=7`);
                     const weatherData = await weatherResponse.json();
                     if (weatherData.daily) {
                         const selectedDateStr = formatDate(date);
                         const dateIndex = weatherData.daily.time.findIndex(time => time.startsWith(selectedDateStr));
                         if (dateIndex !== -1) {
                             forecastForSelectedDay = {
                                 temp_min: weatherData.daily.temperature_2m_min[dateIndex],
                                 temp_max: weatherData.daily.temperature_2m_max[dateIndex],
                                 weather_code: weatherData.daily.weather_code[dateIndex],
                                 precipitation_probability: weatherData.daily.precipitation_probability_max[dateIndex]
                             };
                         }
                     }
                 }
                weather = forecastForSelectedDay;

                if (!isPublicHoliday(date) && !isWeekend(date)) {
                    // 급식 데이터 (나이스 API)
                    const neisFormattedDate = formatDateForNeis(date);
                    const mealResponse = await fetch(`${NEIS_API_URL}mealServiceDietInfo?key=${NEIS_API_KEY}&type=json&pSize=100&ATPT_OFCDC_SC_CODE=${schoolInfo.regionCode}&SD_SCHUL_CODE=${schoolInfo.code}&MLSV_YMD=${neisFormattedDate}`);
                    const mealData = await mealResponse.json();
                    meal = mealData.mealServiceDietInfo?.[1]?.row || null;

                    // 시간표 데이터
                    const dayOfWeek = getDayName(date);
                    if (customTimetable[dayOfWeek] && customTimetable[dayOfWeek].some(item => item)) {
                        timetable = customTimetable[dayOfWeek].map((subject, index) => ({
                            PERIO: index + 1,
                            ITRT_CNTNT: subject
                        }));
                    } else {
                        const timetableResponse = await fetch(`${NEIS_API_URL}elsTimetable?key=${NEIS_API_KEY}&type=json&pSize=100&ATPT_OFCDC_SC_CODE=${schoolInfo.regionCode}&SD_SCHUL_CODE=${schoolInfo.code}&AY=${date.getFullYear()}&SEM=${getSemester(date)}&ALL_TI_YMD=${neisFormattedDate}&GRADE=${schoolInfo.grade}&CLASS_NM=${schoolInfo.class}`);
                        const timetableData = await timetableResponse.json();
                        timetable = timetableData.elsTimetable?.[1]?.row || null;
                    }
                }

            } catch (error) {
                console.error("API 데이터 로딩 중 오류 발생:", error);
                meal = null;
                timetable = null;
            } finally {
                isLoading = false;
                render();
            }
        };

        // 헬퍼 함수
        const formatDate = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        const formatDateForNeis = d => `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
        const getSemester = d => (d.getMonth() + 1 >= 3 && d.getMonth() + 1 <= 7) ? '1' : '2';
        const getDayName = d => ['일', '월', '화', '수', '목', '금', '토'][d.getDay()];
        const isWeekend = d => d.getDay() === 0 || d.getDay() === 6;
        const isRain = code => [51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code);
        const isSnow = code => [71, 73, 75, 85, 86].includes(code);

        // 이벤트 핸들러
        const handleDateChange = (days) => {
            date.setDate(date.getDate() + days);
            if (schoolInfo.code && schoolInfo.regionCode) fetchData();
            else render();
        };
        const goToToday = () => {
            date = new Date();
            if (schoolInfo.code && schoolInfo.regionCode) fetchData();
            else render();
        };
        const handleSchoolSearch = async () => {
            if (!searchQuery) return;
            try {
                const response = await fetch(`${NEIS_API_URL}schoolInfo?key=${NEIS_API_KEY}&type=json&pSize=100&SCHUL_NM=${searchQuery}`);
                const data = await response.json();
                searchResults = data.schoolInfo?.[1]?.row || [];
            } catch (error) {
                console.error("학교 검색 중 오류 발생:", error);
                searchResults = [];
            }
            render();
        };
        const saveSettings = () => {
            localStorage.setItem('schoolInfo', JSON.stringify(schoolInfo));
            localStorage.setItem('customTimetable', JSON.stringify(customTimetable));
            view = 'main';
            if (schoolInfo.code && schoolInfo.regionCode) fetchData();
            else render();
        };
        
        const getCombinedText = () => {
            const dateText = `날씨: ${weather ? `${Math.round(weather.temp_max)}°/${Math.round(weather.temp_min)}°` : '정보 없음'}`;
            const mealText = `급식메뉴: ${meal && meal.length > 0 ? meal[0].DDISH_NM.split('<br/>').map(item => item.replace(/\((.*?)\)/g, '').trim()).join(', ') : '정보 없음'}`;
            const timetableText = `시간표: ${timetable && timetable.length > 0 ? timetable.filter(item => item.ITRT_CNTNT).map(item => item.ITRT_CNTNT).join(' ') : '정보 없음'}`;
            return `${dateText}\n\n${mealText}\n\n${timetableText}`;
        };
        
        const handleCopy = () => {
            const combinedText = getCombinedText();
            const tempElement = document.createElement('textarea');
            tempElement.value = combinedText;
            document.body.appendChild(tempElement);
            tempElement.select();
            document.execCommand('copy');
            document.body.removeChild(tempElement);
        };
        
        const handleShare = () => {
            if (navigator.share) {
                navigator.share({
                    title: `${schoolInfo.name} ${schoolInfo.grade}학년 ${schoolInfo.class}반 정보`,
                    text: getCombinedText(),
                }).catch((error) => console.log('공유 실패', error));
            } else {
                console.log('웹 공유 API를 지원하지 않는 환경입니다.');
            }
        };

        // UI 렌더링 함수
        const render = () => {
            if (view === 'main') {
                mainViewContainer.classList.remove('hidden');
                settingsViewContainer.classList.add('hidden');
                renderMainView();
            } else {
                mainViewContainer.classList.add('hidden');
                settingsViewContainer.classList.remove('hidden');
                renderSettingsView();
            }
            addEventListeners();
        };
        
        // 메인 화면 렌더링
        const renderMainView = () => {
            const isSchoolSet = schoolInfo.code && schoolInfo.regionCode;
            const todayIsWeekend = isWeekend(date);
            const holidayName = isPublicHoliday(date);
            const isHoliday = !!holidayName;
            const isRegularWorkingDay = !todayIsWeekend && !isHoliday;
            const hasData = isRegularWorkingDay && (meal || timetable);

            let content = `
                <div class="min-h-screen p-4 flex flex-col items-center">
                    <header class="w-full max-w-lg mb-6 pt-12 relative">
                        <div class="flex justify-between items-center mb-2">
                            <h1 class="text-xl font-bold">시간표 급식표 조회</h1>
                            <button id="settings-btn" class="text-2xl text-current focus:outline-none" aria-label="설정">&#9881;</button>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            ${schoolInfo.name ? `${schoolInfo.name} ${schoolInfo.grade}학년 ${schoolInfo.class}반` : '학교를 선택하세요'}
                        </p>
                    </header>
            `;

            if (isSchoolSet) {
                content += `
                    <!-- 날짜 네비게이션 -->
                    <div class="w-full max-w-lg flex justify-between items-center p-4 mb-6 rounded-2xl bg-white dark:bg-gray-800 shadow-md">
                        <button id="prev-date-btn" class="text-lg text-gray-600 dark:text-gray-300 focus:outline-none">&lt;</button>
                        <div class="flex flex-col items-center">
                            <span class="text-xl font-bold">${date.getMonth() + 1}월 ${date.getDate()}일</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                ${getDayName(date)}요일
                                ${date.toDateString() !== new Date().toDateString() ? `<button id="today-btn" class="ml-2 text-blue-500 hover:underline focus:outline-none">오늘</button>` : ''}
                            </span>
                        </div>
                        <button id="next-date-btn" class="text-lg text-gray-600 dark:text-gray-300 focus:outline-none">&gt;</button>
                    </div>
                `;

                if (isLoading) {
                    content += `<div class="w-full max-w-lg p-6 mb-4 rounded-2xl bg-white dark:bg-gray-800 shadow-md flex justify-center items-center h-40"><p class="text-lg text-blue-500 dark:text-blue-400">정보 로딩 중...</p></div>`;
                } else {
                    if (todayIsWeekend || isHoliday) {
                        content += `
                            <div class="w-full max-w-lg p-8 mb-6 rounded-2xl shadow-xl border-4 ${isHoliday ? 'bg-red-100 dark:bg-red-900 border-red-500 dark:border-red-400' : 'bg-blue-100 dark:bg-blue-900 border-blue-500 dark:border-blue-400'}">
                                <h2 class="text-3xl font-bold text-center">${isHoliday ? `공휴일 (${holidayName})` : '휴일 (토/일요일)'}</h2>
                                ${!isHoliday ? `<p class="text-center text-blue-500 dark:text-blue-300 mt-2">(시간표와 급식 정보는 제공되지 않습니다)</p>` : ''}
                            </div>
                        `;
                    }
                    if (isRegularWorkingDay && !hasData) {
                         content += `
                            <div class="w-full max-w-lg p-8 mb-6 rounded-2xl bg-yellow-100 dark:bg-yellow-900 shadow-xl border-4 border-yellow-500 dark:border-yellow-400">
                                <h2 class="text-3xl font-bold text-center text-yellow-700 dark:text-yellow-200">정보 없음</h2>
                                <p class="text-center text-yellow-500 dark:text-yellow-300 mt-2">(선택된 날짜의 시간표/급식 정보가 없습니다. 변동 공휴일이나 휴교일일 수 있습니다.)</p>
                            </div>
                        `;
                    }
                    if (isRegularWorkingDay && hasData) {
                        content += `
                            <div class="w-full max-w-lg p-6 mb-4 rounded-2xl bg-white dark:bg-gray-800 shadow-md">
                                <h2 class="text-lg font-semibold mb-2">${schoolInfo.grade}학년 ${schoolInfo.class}반</h2>
                                <div class="whitespace-pre-line text-base mb-4">${getCombinedText()}</div>
                                <div class="flex justify-end space-x-2">
                                    <button id="copy-btn" class="px-4 py-2 rounded-2xl bg-gray-200 dark:bg-gray-700 text-sm font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200">복사하기</button>
                                    <button id="share-btn" class="px-4 py-2 rounded-2xl bg-blue-500 text-white text-sm font-bold hover:bg-blue-600 transition-colors duration-200">공유하기</button>
                                </div>
                            </div>`;
                    }

                    // 날씨 카드
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // 시간 정보를 제거하여 날짜만 비교
                    let weatherContent;

                    if (date < today) {
                        weatherContent = `<p class="text-gray-500 dark:text-gray-400">과거 날씨 정보는 제공하지 않습니다.</p>`;
                    } else if (weather && weather.weather_code !== undefined) {
                        weatherContent = `
                            <div class="flex items-center space-x-4">
                                <p class="text-xl font-bold">
                                    ${Math.round(weather.temp_max)}°/${Math.round(weather.temp_min)}°
                                    ${isRain(weather.weather_code) && weather.precipitation_probability > 0 ? `<span class="ml-2 text-sm text-gray-600 dark:text-gray-300">(비, ${weather.precipitation_probability}%)</span>` : ''}
                                    ${isSnow(weather.weather_code) ? `<span class="ml-2 text-sm text-gray-600 dark:text-gray-300">(눈)</span>` : ''}
                                </p>
                            </div>`;
                    } else {
                        weatherContent = `<p class="text-gray-500 dark:text-gray-400">날씨 정보를 불러올 수 없습니다. (7일치 예보만 제공)</p>`;
                    }

                    content += `<div class="w-full max-w-lg p-6 mb-4 rounded-2xl bg-white dark:bg-gray-800 shadow-md">
                        <h2 class="text-lg font-semibold mb-2">날씨</h2>
                        ${weatherContent}
                    </div>`;

                    // 시간표 카드
                    if (isRegularWorkingDay && timetable && timetable.length > 0) {
                        content += `
                            <div class="w-full max-w-lg p-6 mb-4 rounded-2xl bg-white dark:bg-gray-800 shadow-md">
                                <h2 class="text-lg font-semibold mb-2">시간표</h2>
                                <ul class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    ${timetable.filter(item => item.ITRT_CNTNT).map(item => `
                                        <li class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-center text-sm">
                                            <span class="font-bold">${item.PERIO}교시:</span> ${item.ITRT_CNTNT}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>`;
                    }
                    
                    // 급식 카드
                    if (isRegularWorkingDay && meal && meal.length > 0) {
                        content += `
                            <div class="w-full max-w-lg p-6 mb-4 rounded-2xl bg-white dark:bg-gray-800 shadow-md">
                                <h2 class="text-lg font-semibold mb-2">급식표</h2>
                                <ul>
                                    ${meal[0].DDISH_NM.split('<br/>').map(item => `
                                        <li class="py-1 text-gray-700 dark:text-gray-200">${item.replace(/\((.*?)\)/g, '').trim()}</li>
                                    `).join('')}
                                </ul>
                            </div>`;
                    }
                }
            } else {
                content += `<div class="w-full max-w-lg p-6 mb-4 rounded-2xl bg-white dark:bg-gray-800 shadow-md flex justify-center items-center h-48"><p class="text-lg text-gray-500 dark:text-gray-400 text-center">설정에서 정보를 입력해주세요.</p></div>`;
            }

            content += `</div>`;
            mainViewContainer.innerHTML = content;
        };
        
        // 설정 화면 렌더링
        const renderSettingsView = () => {
            const getTimetableRows = () => {
                const maxPeriod = Math.max(8, ...Object.values(customTimetable).map(day => day ? day.length : 0).filter(len => len > 0));
                return Array.from({ length: maxPeriod }, (_, i) => i + 1);
            };

            settingsViewContainer.innerHTML = `
                <div class="min-h-screen p-4 flex flex-col items-center">
                    <div class="w-full max-w-4xl p-6 rounded-2xl bg-white dark:bg-gray-800 shadow-lg relative">
                        <h1 class="text-2xl font-bold mb-6">학교 설정 및 시간표 편집</h1>
                        <div class="flex flex-col md:flex-row gap-8">
                            <!-- 좌측: 학교 정보 설정 -->
                            <div class="w-full md:w-1/3 space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">학교명</label>
                                    <div class="flex whitespace-nowrap">
                                        <input id="school-search-input" type="text" value="${searchQuery}" placeholder="학교를 검색하세요" class="w-full px-4 py-3 rounded-l-2xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"/>
                                        <button id="school-search-btn" class="px-6 py-3 rounded-r-2xl bg-blue-500 text-white font-bold hover:bg-blue-600 transition-colors duration-200">검색</button>
                                    </div>
                                    <ul id="search-results-list" class="mt-2 max-h-40 overflow-y-auto rounded-2xl border border-gray-300 dark:border-gray-600">
                                        ${searchResults.map(school => `
                                            <li data-name="${school.SCHUL_NM}" data-code="${school.SD_SCHUL_CODE}" data-region-code="${school.ATPT_OFCDC_SC_CODE}" data-region-name="${school.LCTN_SC_NM}" class="p-3 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200">${school.SCHUL_NM}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <!-- 학년 선택 -->
                                <div>
                                    <label class="block text-sm font-semibold mb-2">학년</label>
                                    <select id="grade-select" class="w-full px-4 py-3 rounded-2xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
                                        <option value="">학년을 선택하세요</option>
                                        ${[1, 2, 3].map(grade => `<option value="${grade}" ${schoolInfo.grade == grade ? 'selected' : ''}>${grade}학년</option>`).join('')}
                                    </select>
                                </div>
                                <!-- 반 선택 -->
                                <div>
                                    <label class="block text-sm font-semibold mb-2">반</label>
                                    <select id="class-select" class="w-full px-4 py-3 rounded-2xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
                                        <option value="">반을 선택하세요</option>
                                        ${[...Array(20).keys()].map(i => `<option value="${i + 1}" ${schoolInfo.class == (i + 1) ? 'selected' : ''}>${i + 1}반</option>`).join('')}
                                    </select>
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-4">* 학교 정보는 나이스 교육정보 개방포털에서 제공됩니다.</p>
                            </div>
                            <!-- 우측: 시간표 편집 -->
                            <div class="w-full md:w-2/3">
                                <h3 class="text-lg font-semibold mb-4">시간표 직접 입력</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full table-auto">
                                        <thead>
                                            <tr class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                                                <th class="px-2 py-2 text-center">교시</th>
                                                ${['월', '화', '수', '목', '금'].map(day => `<th class="px-2 py-2 text-center">${day}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${getTimetableRows().map(period => `
                                                <tr class="border-b border-gray-300 dark:border-gray-600">
                                                    <td class="px-2 py-2 text-center font-bold">${period}</td>
                                                    ${['월', '화', '수', '목', '금'].map(day => `
                                                        <td class="px-2 py-2">
                                                            <input type="text" data-day="${day}" data-period="${period}" value="${(customTimetable[day] && customTimetable[day][period - 1]) || ''}" class="timetable-input w-full px-2 py-1 text-center rounded-md border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                                        </td>
                                                    `).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4 mt-8">
                            <button id="cancel-settings-btn" class="px-6 py-3 rounded-2xl bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white font-bold hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors duration-200">취소</button>
                            <button id="save-settings-btn" class="px-6 py-3 rounded-2xl bg-blue-500 text-white font-bold hover:bg-blue-600 transition-colors duration-200">저장</button>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // 이벤트 리스너 추가 함수
        const addEventListeners = () => {
            if (view === 'main') {
                document.getElementById('settings-btn')?.addEventListener('click', () => { view = 'settings'; render(); });
                document.getElementById('prev-date-btn')?.addEventListener('click', () => handleDateChange(-1));
                document.getElementById('next-date-btn')?.addEventListener('click', () => handleDateChange(1));
                document.getElementById('today-btn')?.addEventListener('click', goToToday);
                document.getElementById('copy-btn')?.addEventListener('click', handleCopy);
                document.getElementById('share-btn')?.addEventListener('click', handleShare);
            } else {
                document.getElementById('school-search-input').addEventListener('input', (e) => { searchQuery = e.target.value; });
                document.getElementById('school-search-btn').addEventListener('click', handleSchoolSearch);
                document.getElementById('search-results-list').addEventListener('click', (e) => {
                    if (e.target.tagName === 'LI') {
                        schoolInfo = { ...schoolInfo, name: e.target.dataset.name, code: e.target.dataset.code, regionCode: e.target.dataset.regionCode, regionName: e.target.dataset.regionName };
                        searchResults = [];
                        render();
                    }
                });
                document.getElementById('grade-select').addEventListener('change', (e) => { schoolInfo.grade = e.target.value; });
                document.getElementById('class-select').addEventListener('change', (e) => { schoolInfo.class = e.target.value; });
                document.querySelectorAll('.timetable-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const { day, period } = e.target.dataset;
                        const value = e.target.value;
                        if (!customTimetable[day]) {
                            customTimetable[day] = [];
                        }
                         while (customTimetable[day].length < period) {
                             customTimetable[day].push('');
                         }
                        customTimetable[day][period - 1] = value;
                    });
                });
                document.getElementById('cancel-settings-btn').addEventListener('click', () => { view = 'main'; render(); });
                document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            }
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            const savedSchoolInfo = localStorage.getItem('schoolInfo');
            if (savedSchoolInfo) {
                schoolInfo = JSON.parse(savedSchoolInfo);
            }
            const savedTimetable = localStorage.getItem('customTimetable');
            if (savedTimetable) {
                customTimetable = JSON.parse(savedTimetable);
            }

            if (schoolInfo.code && schoolInfo.regionCode) {
                fetchData();
            } else {
                render();
            }
        });
    </script>
</body>
</html>

